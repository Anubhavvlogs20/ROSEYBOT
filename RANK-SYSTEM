ROSEY BOT",
    Content = "Rank System Loaded ğŸŒ¹"
})-- ğŸŒ¹ ROSEY BOT - Rank System (FULLY FIXED + CHAT SEND + HISTORY SEND)

local Rayfield = loadstring(game:HttpGet("https://sirius.menu/rayfield"))()

local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local TextChatService = game:GetService("TextChatService")

--==================================================
-- DATE / PATHS
--==================================================
local DAY = os.date("%d")
local MONTH = os.date("%m")
local YEAR = os.date("%Y")

local BASE_FOLDER = "ROSEY RANK DATA"
local MONTH_FOLDER = BASE_FOLDER.."/"..MONTH.." | "..YEAR
local HISTORY_FILE = MONTH_FOLDER.."/ROSEY RANK HISTORY-"..DAY.." | "..MONTH.." | "..YEAR..".txt"

if not isfolder(BASE_FOLDER) then makefolder(BASE_FOLDER) end
if not isfolder(MONTH_FOLDER) then makefolder(MONTH_FOLDER) end
if not isfile(HISTORY_FILE) then writefile(HISTORY_FILE, "") end

--==================================================
-- DATA
--==================================================
local savedRanks = {}

--==================================================
-- UI
--==================================================
local Window = Rayfield:CreateWindow({
    Name = "ğŸŒ¹ ROSEY BOT",
    LoadingTitle = "ROSEY BOT",
    LoadingSubtitle = "Rank System",
    ConfigurationSaving = {Enabled=false}
})

local RankTab = Window:CreateTab("â¬† Ranks", 4483362458)
local HistoryTab = Window:CreateTab("ğŸ“œ History", 4483362458)
local StatsTab = Window:CreateTab("ğŸ“Š Stats", 4483362458)

--==================================================
-- RANK LIST (ALL)
--==================================================
local ALL_RANKS = {
    "Guest","Newbie","Member","Verified","Trusted","OG","Veteran","Day 1",
    "VIP","VIP+","VIP++","Premium","Premium+","Lifetime VIP","Supporter","Sponsor","Donator","Top Donator",
    "MVP","MVP+","MVP++","Champion","Elite","Master","Legend","Mythic","Immortal","Ascended","Ultimate",
    "Helper","Trial Mod","Moderator","Senior Moderator","Admin","Senior Admin","Head Admin","Manager","Supervisor","Management","Developer","Lead Developer","Builder","Co-Owner","Owner","Founder","Creator",
    "YouTuber","TikToker","Streamer","Influencer","Partner","Verified Creator","Content Creator","Celebrity","Content God",
    "Sigma","Sigma Male","Gigachad","Rizzler","Rizz God","Ohio Resident","Skibidi Warrior","NPC","Main Character","Touch Grass","Ratio King","L + Bozo","Certified Hood Classic",
    "BedWars God","SkyWars Sweat","Arsenal Tryhard","Blade Ball Pro","Blox Fruits Pirate","Anime Fighter","MM2 God","Tower Defense Legend",
    "God","Demi-God","Titan","Overlord","Emperor","King","Queen","Prince","Princess","Final Boss","World Breaker","Reality Bender",
    "Hokage","Pirate King","Titan Shifter","Hashira","Jujutsu Sorcerer","Ghoul","Stand User","Shinigami","Demon Slayer","Saiyan",
    "Angel","Fallen Angel","Demon","Devil","Vampire","Werewolf","Reaper","Ghost","Dragon","Phoenix","Unicorn","Void Walker",
    "Bestie","Homie","Brother","Sister","Ride or Die","Soulmate","My Person","Family","Forever Friend","Rosey's Favorite",
    "Millionaire","Billionaire","Trillionaire","Robux Whale","Money Printer","Rich Kid",
    "Santa","Pumpkin King","Valentine","Birthday Boy","Birthday Girl","Anniversary Star",
    "Noob","Trash","Clown","Loser","Muted","Demoted","Ex-Staff","Banned (Fake)","Washed","Mid","Fell Off",
    "Hacker","1337","Cyber God","Matrix Dweller","Code Master","Exploit Lord"
}

--==================================================
-- MESSAGES
--==================================================
local PROMOTE_MESSAGES = {
    "@{{player}} has been promoted to {{rank}}! ğŸ‰",
    "Congrats @{{player}} â€” you're now {{rank}}! ğŸŒ¹",
    "Everyone welcome our new {{rank}}: @{{player}}! ğŸ‘‹",
    "Rank up! @{{player}} â†’ {{rank}} ğŸ”¥",
    "A GOD HAS DESCENDED â€” @{{player}} is now {{rank}}! âš¡",
    "Real recognize real â€” @{{player}} earned {{rank}} status. No cap.",
    "Bow down to @{{player}}, the new {{rank}}! ğŸ‘‘",
    "The server just got stronger â€” @{{player}} is {{rank}}! ğŸ’ª",
    "New rank dropped: @{{player}} â†’ {{rank}}! ğŸš€",
    "All hail @{{player}} â€” {{rank}} secured forever! ğŸ†",
    "L + ratio if you disagree â€” @{{player}} is {{rank}} ğŸ˜ˆ",
    "@{{player}} just claimed {{rank}} status. Respect. ğŸ™Œ",
    "Lifetime title unlocked: @{{player}} is {{rank}} now and forever.",
    "The server trembles â€” @{{player}} ascended to {{rank}}! ğŸŒ‹",
    "Day 1 energy â€” @{{player}} promoted to {{rank}}! Loyal forever.",
    "My circle only â€” @{{player}} is officially {{rank}} now.",
    "Not everyone gets this â€” @{{player}} earned {{rank}}. Facts.",
    "Distance means nothing â€” @{{player}} is {{rank}} in my book.",
    "They don't make 'em like @{{player}} anymore â€” {{rank}} secured.",
    "Real ones only â€” @{{player}} = {{rank}}. That's on everything.",
    "Ohio rizz activated â€” @{{player}} is now {{rank}}! ğŸ—¿",
    "Gigachad approved â€” @{{player}} is {{rank}}! ğŸ’ªğŸ—¿",
    "Mewing master @{{player}} just unlocked {{rank}}! ğŸ˜",
    "Rosey's favorite â€” @{{player}} is {{rank}} forever! â¤ï¸",
    "Bot abuser detected â€” @{{player}} claimed {{rank}}! ğŸ¤–"
}

local DEMOTE_MESSAGES = {
    "@{{player}} has been demoted to {{rank}}... oof ğŸ’€",
    "Sorry @{{player}} â€” you've been decreased to {{rank}} ğŸ˜”",
    "Rank down! @{{player}} â†’ {{rank}} ğŸ“‰",
    "L + ratio + @{{player}} dropped to {{rank}} ğŸ˜‚",
    "Touch grass time â€” @{{player}} decreased to {{rank}} ğŸŒ±",
    "Skill issue detected â€” @{{player}} is now {{rank}} ğŸ¤¡",
    "From hero to zero â€” @{{player}} demoted to {{rank}} ğŸ˜­",
    "Better luck next time â€” @{{player}} decreased to {{rank}} ğŸ‘",
    "Fatherless behavior â€” @{{player}} dropped to {{rank}} ğŸ‘¨â€ğŸ¦²",
    "Bozo moment â€” @{{player}} is now {{rank}} ğŸ¤¡",
    "Ratio'd hard â€” @{{player}} decreased to {{rank}} ğŸ“‰",
    "You fell off â€” @{{player}} demoted to {{rank}} ğŸ˜",
    "Mid energy â€” @{{player}} is now {{rank}} ğŸ¥±",
    "Clown promotion reversed â€” @{{player}} decreased to {{rank}} ğŸª",
    "No cap, you lost it â€” @{{player}} dropped to {{rank}} ğŸ˜¬",
    "Ohio resident confirmed â€” @{{player}} demoted to {{rank}} ğŸ—¿",
    "Skibidi toilet flush â€” @{{player}} decreased to {{rank}} ğŸš½",
    "Gigachad revoked â€” @{{player}} is now {{rank}} ğŸ’”",
    "Mewing failed â€” @{{player}} dropped to {{rank}} ğŸ˜",
    "Looksmaxxing over â€” @{{player}} decreased to {{rank}} ğŸ˜¢",
    "Certified L â€” @{{player}} is now {{rank}} ğŸ“‰",
    "Rosey disappointed â€” @{{player}} demoted to {{rank}} ğŸ’”",
    "Bot abused you back â€” @{{player}} decreased to {{rank}} ğŸ¤–",
    "Day 1 over â€” @{{player}} dropped to {{rank}} ğŸ‘‹",
    "Real one no more â€” @{{player}} is now {{rank}} ğŸ˜”"
}

--==================================================
-- HELPERS
--==================================================
local function formatMessage(text)
    text = tostring(text):gsub("^%[ROSEY BOT%]%s*", "")
    return "[ROSEY BOT] "..text
end

local function buildMessage(list, player, rank)
    local msg = list[math.random(#list)]
    msg = msg:gsub("{{player}}", player):gsub("{{rank}}", rank)
    return formatMessage(msg)
end

local function logHistory(text)
    local line = "["..os.date("%H:%M:%S").."] "..text
    appendfile(HISTORY_FILE, line.."\n")
end

local function sendToChat(msg)
    pcall(function()
        if TextChatService.ChatVersion == Enum.ChatVersion.TextChatService then
            local channel = TextChatService.TextChannels:FindFirstChild("RBXGeneral")
            if channel then
                channel:SendAsync(msg)
            end
        else
            game.ReplicatedStorage.DefaultChatSystemChatEvents.SayMessageRequest:FireServer(msg, "All")
        end
    end)
end

--==================================================
-- PLAYER + RANK SELECTION
--==================================================
local selectedPlayer = nil
local selectedRank = nil

local playerDropdown = RankTab:CreateDropdown({
    Name = "Select Player",
    Options = {},
    CurrentOption = "-- Select Player --",
    Callback = function(opt)
        selectedPlayer = nil
        if opt == "-- Select Player --" then return end
        for _,p in ipairs(Players:GetPlayers()) do
            local str = p.DisplayName.." (@"..p.Name..")"
            if opt == str then
                selectedPlayer = p
                break
            end
        end
    end
})

local function refreshPlayers()
    local t = {"-- Select Player --"}
    for _,p in ipairs(Players:GetPlayers()) do
        table.insert(t, p.DisplayName.." (@"..p.Name..")")
    end
    playerDropdown:Refresh(t, true)
end

refreshPlayers()
Players.PlayerAdded:Connect(refreshPlayers)
Players.PlayerRemoving:Connect(refreshPlayers)

RankTab:CreateDropdown({
    Name = "Select Rank",
    Options = ALL_RANKS,
    CurrentOption = ALL_RANKS[1],
    Callback = function(opt)
        selectedRank = opt
    end
})

--==================================================
-- PROMOTE / DEMOTE (NOW SENDS TO CHAT)
--==================================================
RankTab:CreateButton({
    Name = "â¬† Promote",
    Callback = function()
        if not selectedPlayer or not selectedRank then
            Rayfield:Notify({Title="Error",Content="Select player & rank"})
            return
        end

        savedRanks[selectedPlayer.UserId] = selectedRank
        local msg = buildMessage(PROMOTE_MESSAGES, selectedPlayer.DisplayName, selectedRank)
        logHistory(msg)
        sendToChat(msg)
        Rayfield:Notify({Title="PROMOTED",Content=msg})
    end
})

RankTab:CreateButton({
    Name = "â¬‡ Demote",
    Callback = function()
        if not selectedPlayer or not selectedRank then
            Rayfield:Notify({Title="Error",Content="Select player & rank"})
            return
        end

        savedRanks[selectedPlayer.UserId] = selectedRank
        local msg = buildMessage(DEMOTE_MESSAGES, selectedPlayer.DisplayName, selectedRank)
        logHistory(msg)
        sendToChat(msg)
        Rayfield:Notify({Title="DEMOTED",Content=msg})
    end
})

--==================================================
-- HISTORY TAB (FIXED SEND TO CHAT)
--==================================================
local function getMonthFolders()
    local t = {}
    if isfolder(BASE_FOLDER) then
        for _,f in ipairs(listfiles(BASE_FOLDER)) do
            if isfolder(f) then
                local name = f:match("([^/\\]+)$")
                table.insert(t, name)
            end
        end
    end
    return t
end

local function getDays(monthYear)
    local t = {}
    local folder = BASE_FOLDER.."/"..monthYear
    if isfolder(folder) then
        for _,f in ipairs(listfiles(folder)) do
            local name = f:match("ROSEY RANK HISTORY%-(.+)%..+%.txt")
            if name then table.insert(t, name) end
        end
    end
    return t
end

local selectedMonthYear = MONTH.." | "..YEAR
local selectedDayFile

local historyLabel = HistoryTab:CreateParagraph({Title = "History", Content = "Select date to view"})

local monthDropdown = HistoryTab:CreateDropdown({
    Name = "ğŸ“… Month | Year",
    Options = getMonthFolders(),
    CurrentOption = selectedMonthYear,
    Callback = function(opt)
        selectedMonthYear = opt
        dayDropdown:Refresh(getDays(opt), true)
    end
})

local dayDropdown = HistoryTab:CreateDropdown({
    Name = "ğŸ“… Day",
    Options = {},
    Callback = function(day)
        selectedDayFile = day
        local path = BASE_FOLDER.."/"..selectedMonthYear.."/ROSEY RANK HISTORY-"..day..".txt"
        if isfile(path) then
            historyLabel:Set({Title = "History - "..day, Content = readfile(path)})
        else
            historyLabel:Set({Title = "History", Content = "No file"})
        end
    end
})

HistoryTab:CreateButton({
    Name = "ğŸ§¾ Send Day History to Chat",
    Callback = function()
        if not selectedDayFile then
            Rayfield:Notify({Title="Error",Content="Select day first"})
            return
        end

        local path = BASE_FOLDER.."/"..selectedMonthYear.."/ROSEY RANK HISTORY-"..selectedDayFile..".txt"
        if isfile(path) then
            local content = readfile(path)
            for line in content:gmatch("[^\n]+") do
                sendToChat(line)
                task.wait(0.3)  -- Avoid spam detection
            end
            Rayfield:Notify({Title="Sent",Content="History sent to chat"})
        end
    end
})

--==================================================
-- STATS TAB
--==================================================
local function getStats()
    local counts = {}
    for _,r in pairs(savedRanks) do
        counts[r] = (counts[r] or 0) + 1
    end

    local text = "ğŸ“Š Current Rank Stats\n\n"
    if next(counts) == nil then text = text.."No ranks assigned yet" end
    for r,c in pairs(counts) do
        text ..= r.." : "..c.." players\n"
    end
    return text
end

local statsLabel = StatsTab:CreateParagraph({Title = "Rank Stats", Content = getStats()})

StatsTab:CreateButton({
    Name = "ğŸ”„ Refresh Stats",
    Callback = function()
        statsLabel:Set({Content = getStats()})
    end
})

Rayfield:Notify({
    Title = "ROSEY BOT",
    Content = "Rank System Loaded â€“ Promote/Demote Sends to Chat + History Export Fixed ğŸŒ¹"
})
